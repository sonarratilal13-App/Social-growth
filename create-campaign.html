<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Campaign - Social Growth</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="supabase.js" defer></script>
    <script src="auth.js" defer></script>
    <style>
        .create-header {
            background: linear-gradient(135deg, var(--green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .create-content {
            padding: 2rem 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }

        .form-section {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
        }

        .preview-section {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .preview-video {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--light-gray);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
        }

        .cost-breakdown {
            background: var(--light-green);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .cost-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--black);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--green);
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .duration-option {
            padding: 1rem;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .duration-option:hover {
            border-color: var(--green);
        }

        .duration-option.selected {
            border-color: var(--green);
            background: var(--light-green);
        }

        .duration-time {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .duration-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .campaign-features {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 8px;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: var(--green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .balance-warning {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #92400E;
        }

        @media (max-width: 968px) {
            .create-content {
                grid-template-columns: 1fr;
            }

            .preview-section {
                position: static;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="create-header">
        <div class="container header-content">
            <a href="dashboard.html" class="logo">
                <span class="logo-icon">ðŸ“ˆ</span>
                Social Growth
            </a>
            <div class="user-info">
                <span data-user-name>Loading...</span>
                <div class="user-avatar" data-user-avatar>U</div>
                <a href="dashboard.html" class="btn btn-outline btn-small" style="background: rgba(255,255,255,0.2); color: white; border-color: white;">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </header>

    <!-- Create Content -->
    <div class="container create-content">
        <!-- Form Section -->
        <div class="form-section">
            <h2 class="section-title">Create New Campaign</h2>
            <p class="mb-3" style="color: var(--gray);">Boost your YouTube video by creating a watch campaign</p>

            <form id="campaignForm" onsubmit="handleCampaignCreation(event)">
                <!-- YouTube URL -->
                <div class="form-group">
                    <label class="form-label" for="videoUrl">
                        <i class="fab fa-youtube"></i> YouTube Video URL
                    </label>
                    <input type="url" class="form-input" id="videoUrl" required 
                           placeholder="https://www.youtube.com/watch?v=..."
                           onchange="updatePreview()">
                    <div class="form-help">Paste the full YouTube video URL</div>
                </div>

                <!-- Video Title -->
                <div class="form-group">
                    <label class="form-label" for="videoTitle">
                        <i class="fas fa-heading"></i> Campaign Title
                    </label>
                    <input type="text" class="form-input" id="videoTitle" required 
                           placeholder="Enter a title for your campaign"
                           oninput="updatePreview()">
                </div>

                <!-- Video Duration -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-clock"></i> Video Duration
                    </label>
                    <select class="form-select" id="videoDuration" onchange="calculateCost()" required>
                        <option value="">Select video duration</option>
                        <option value="60">1 minute</option>
                        <option value="120">2 minutes</option>
                        <option value="180">3 minutes</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="900">15 minutes</option>
                        <option value="1800">30 minutes</option>
                        <option value="custom">Custom duration</option>
                    </select>
                </div>

                <!-- Custom Duration (hidden by default) -->
                <div class="form-group" id="customDurationGroup" style="display: none;">
                    <label class="form-label" for="customDuration">
                        <i class="fas fa-clock"></i> Custom Duration (seconds)
                    </label>
                    <input type="number" class="form-input" id="customDuration" 
                           min="30" max="3600" step="30"
                           placeholder="Enter duration in seconds"
                           onchange="calculateCost()">
                    <div class="form-help">Must be in multiples of 30 seconds</div>
                </div>

                <!-- Campaign Duration -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i> Campaign Duration
                    </label>
                    <div class="duration-options">
                        <div class="duration-option" onclick="selectDuration(3600)">
                            <div class="duration-time">1 hour</div>
                            <div class="duration-label">Quick boost</div>
                        </div>
                        <div class="duration-option" onclick="selectDuration(10800)">
                            <div class="duration-time">3 hours</div>
                            <div class="duration-label">Standard</div>
                        </div>
                        <div class="duration-option" onclick="selectDuration(21600)">
                            <div class="duration-time">6 hours</div>
                            <div class="duration-label">Extended</div>
                        </div>
                        <div class="duration-option" onclick="selectDuration(43200)">
                            <div class="duration-time">12 hours</div>
                            <div class="duration-label">Maximum</div>
                        </div>
                    </div>
                    <input type="hidden" id="campaignDuration" value="3600" required>
                </div>

                <!-- Expected Watchers -->
                <div class="form-group">
                    <label class="form-label" for="expectedWatchers">
                        <i class="fas fa-users"></i> Expected Concurrent Watchers
                    </label>
                    <select class="form-select" id="expectedWatchers" onchange="calculateCost()" required>
                        <option value="1">1 watcher</option>
                        <option value="3" selected>3 watchers</option>
                        <option value="5">5 watchers</option>
                        <option value="10">10 watchers</option>
                    </select>
                    <div class="form-help">Number of people expected to watch simultaneously</div>
                </div>

                <!-- Cost Breakdown -->
                <div class="cost-breakdown">
                    <h4 style="margin-bottom: 1rem;">Cost Breakdown</h4>
                    <div class="cost-item">
                        <span>Video intervals:</span>
                        <span id="intervalsCount">0 intervals</span>
                    </div>
                    <div class="cost-item">
                        <span>Coins per interval:</span>
                        <span>3 coins</span>
                    </div>
                    <div class="cost-item">
                        <span>Expected watchers:</span>
                        <span id="watchersCount">3 watchers</span>
                    </div>
                    <div class="cost-total">
                        <span>Total Cost:</span>
                        <span id="totalCost">0 coins</span>
                    </div>
                </div>

                <!-- Balance Check -->
                <div class="balance-warning" id="balanceWarning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Insufficient Balance:</strong> You need <span id="requiredCoins">0</span> coins but only have <span id="currentBalance">0</span> coins.
                    <a href="#" onclick="showBuyCoinsModal()" style="color: var(--green); font-weight: 600;">Buy more coins</a>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-filled w-100" id="submitBtn">
                    <i class="fas fa-rocket"></i> Create Campaign
                </button>
            </form>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
            <h3 class="section-title">Campaign Preview</h3>
            
            <div class="preview-video" id="videoPreview">
                <i class="fab fa-youtube" style="font-size: 3rem;"></i>
                <p>YouTube video preview</p>
            </div>

            <div class="preview-info">
                <h4 id="previewTitle">Your Campaign Title</h4>
                <div class="campaign-meta" style="margin: 1rem 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--gray);">Duration:</span>
                        <span id="previewDuration">0 min</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--gray);">Intervals:</span>
                        <span id="previewIntervals">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--gray);">Total Cost:</span>
                        <span style="font-weight: 700; color: var(--green);" id="previewCost">0 coins</span>
                    </div>
                </div>
            </div>

            <div class="campaign-features">
                <div class="feature">
                    <div class="feature-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <strong>Real Views</strong>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--gray);">Genuine watch time from real users</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <strong>YouTube Compliant</strong>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--gray);">Safe for your channel</p>
                    </div>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <strong>Anti-Cheat Protection</strong>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--gray);">Ensures genuine engagement</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-label">Home</div>
        </a>
        <a href="watch.html" class="nav-item">
            <div class="nav-icon"><i class="fas fa-eye"></i></div>
            <div class="nav-label">Watch</div>
        </a>
        <a href="create-campaign.html" class="nav-item active">
            <div class="nav-icon"><i class="fas fa-rocket"></i></div>
            <div class="nav-label">Create</div>
        </a>
        <a href="#" class="nav-item" onclick="showProfileModal()">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <div class="nav-label">Profile</div>
        </a>
    </nav>

    <!-- Notification System -->
    <div class="notification" id="notification"></div>

    <script>
        let userBalance = 0;

        // Initialize create campaign page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserBalance();
            setupEventListeners();
            calculateCost();
        });

        async function loadUserBalance() {
            const user = authManager.getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const profile = authManager.getUserProfile();
            if (profile) {
                userBalance = profile.coins || 0;
                document.getElementById('currentBalance').textContent = userBalance;
            }
        }

        function setupEventListeners() {
            // Show/hide custom duration field
            document.getElementById('videoDuration').addEventListener('change', function() {
                const customGroup = document.getElementById('customDurationGroup');
                customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                calculateCost();
            });

            // Custom duration validation
            document.getElementById('customDuration').addEventListener('input', function() {
                // Round to nearest 30 seconds
                const value = Math.round(this.value / 30) * 30;
                this.value = value;
                calculateCost();
            });
        }

        function selectDuration(seconds) {
            document.getElementById('campaignDuration').value = seconds;
            
            // Update UI
            document.querySelectorAll('.duration-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            calculateCost();
        }

        function calculateCost() {
            const videoDuration = getVideoDuration();
            const campaignDuration = parseInt(document.getElementById('campaignDuration').value);
            const expectedWatchers = parseInt(document.getElementById('expectedWatchers').value);

            // Calculate intervals (30 seconds each)
            const intervalsPerWatch = Math.ceil(videoDuration / 30);
            const totalIntervals = intervalsPerWatch * expectedWatchers;

            // Calculate cost (3 coins per interval)
            const totalCost = totalIntervals * 3;

            // Update UI
            document.getElementById('intervalsCount').textContent = `${totalIntervals} intervals`;
            document.getElementById('watchersCount').textContent = `${expectedWatchers} watchers`;
            document.getElementById('totalCost').textContent = `${totalCost} coins`;
            document.getElementById('previewIntervals').textContent = totalIntervals;
            document.getElementById('previewCost').textContent = `${totalCost} coins`;
            document.getElementById('previewDuration').textContent = `${Math.round(videoDuration / 60)} minutes`;

            // Check balance
            checkBalance(totalCost);

            return totalCost;
        }

        function getVideoDuration() {
            const durationSelect = document.getElementById('videoDuration');
            if (durationSelect.value === 'custom') {
                return parseInt(document.getElementById('customDuration').value) || 0;
            }
            return parseInt(durationSelect.value) || 0;
        }

        function checkBalance(requiredCoins) {
            const warningElement = document.getElementById('balanceWarning');
            const submitBtn = document.getElementById('submitBtn');
            
            if (requiredCoins > userBalance) {
                warningElement.style.display = 'block';
                document.getElementById('requiredCoins').textContent = requiredCoins;
                document.getElementById('currentBalance').textContent = userBalance;
                submitBtn.disabled = true;
            } else {
                warningElement.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function updatePreview() {
            const videoUrl = document.getElementById('videoUrl').value;
            const title = document.getElementById('videoTitle').value;

            // Update preview title
            document.getElementById('previewTitle').textContent = title || 'Your Campaign Title';

            // Update video preview if YouTube URL
            if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
                const videoId = extractYouTubeId(videoUrl);
                if (videoId) {
                    document.getElementById('videoPreview').innerHTML = `
                        <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"
                             alt="Video thumbnail">
                    `;
                }
            }
        }

        function extractYouTubeId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        async function handleCampaignCreation(event) {
            event.preventDefault();

            const user = authManager.getCurrentUser();
            if (!user) return;

            const videoUrl = document.getElementById('videoUrl').value;
            const videoTitle = document.getElementById('videoTitle').value;
            const videoDuration = getVideoDuration();
            const campaignDuration = parseInt(document.getElementById('campaignDuration').value);
            const expectedWatchers = parseInt(document.getElementById('expectedWatchers').value);

            // Calculate final cost
            const intervalsPerWatch = Math.ceil(videoDuration / 30);
            const totalIntervals = intervalsPerWatch * expectedWatchers;
            const totalCost = totalIntervals * 3;

            // Validate YouTube URL
            if (!isValidYouTubeUrl(videoUrl)) {
                showNotification('Please enter a valid YouTube URL', 'error');
                return;
            }

            // Validate video duration
            if (videoDuration < 30) {
                showNotification('Video duration must be at least 30 seconds', 'error');
                return;
            }

            try {
                // Create campaign
                const campaignData = {
                    user_id: user.id,
                    video_url: videoUrl,
                    video_title: videoTitle,
                    video_length_sec: videoDuration,
                    campaign_length_sec: campaignDuration,
                    coins_per_30s: 3,
                    total_intervals: totalIntervals,
                    current_intervals_completed: 0,
                    status: 'active'
                };

                const { data: campaign, error } = await db.createCampaign(campaignData);
                
                if (error) throw error;

                // Deduct coins from user
                await db.updateUserCoins(user.id, -totalCost);

                showNotification('Campaign created successfully!', 'success');
                
                // Redirect to dashboard after delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Error creating campaign:', error);
                showNotification('Error creating campaign: ' + error.message, 'error');
            }
        }

        function isValidYouTubeUrl(url) {
            const pattern = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            return pattern.test(url);
        }

        function showBuyCoinsModal() {
            // This would typically open the buy coins modal
            // For now, redirect to dashboard where the modal is available
            window.location.href = 'dashboard.html';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
